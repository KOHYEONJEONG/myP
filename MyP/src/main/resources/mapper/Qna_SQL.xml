<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="qna">
	<select id="List" resultType="hashmap">
	SELECT Q.QNA_NUM,Q.TITLE,Q.NM,Q.HIT,Q.DT,Q.ADT,Q.CON            
		FROM(SELECT Q.QNA_NUM,Q.TITLE,M.NM,Q.HIT,Q.CON,
    CASE WHEN TO_CHAR(Q.REG_DT,'YY.MM.DD') = TO_CHAR(SYSDATE, 'YY.MM.DD')
    	THEN TO_CHAR(Q.REG_DT, 'HH24:MI')
    	ELSE TO_CHAR(Q.REG_DT, 'YY.MM.DD')
    END AS DT,
    CASE WHEN TO_CHAR(Q.ANSWER_DT,'YY.MM.DD') = TO_CHAR(SYSDATE, 'YY.MM.DD')
            THEN TO_CHAR(Q.ANSWER_DT, 'HH24:MI')
            ELSE TO_CHAR(Q.ANSWER_DT, 'YY.MM.DD')
    END AS ADT,  
    ROW_NUMBER() OVER(ORDER BY Q.QNA_NUM DESC) AS RNUM
		FROM QNA Q INNER JOIN MEMBER M
    ON Q.MEM_NUM = M.MEM_NUM
    	WHERE Q.DEL = 1
    <if test="searchTxt != null and searchTxt != ''">
    <choose>
    	<when test = "select_b eq title">
    		AND Q.TITLE LIKE '%' || #{searchTxt} || '%'
    	</when>
    	
    	<when test = "select_b eq nickname">
    		AND M.NM LIKE '%' || #{searchTxt} || '%'
    	</when>
    	
    </choose>
    
    </if>
    	)Q
    	WHERE Q.RNUM BETWEEN #{start} AND #{end}
   </select>
			
	<select id="getqna" resultType="hashmap" parameterType="hashmap">
		SELECT Q.QNA_NUM,Q.TITLE,M.NM,Q.HIT,Q.CON,
    	CASE WHEN TO_CHAR(Q.REG_DT,'YY.MM.DD') = TO_CHAR(SYSDATE, 'YY.MM.DD')
    	THEN TO_CHAR(Q.REG_DT, 'HH24:MI')
    	ELSE TO_CHAR(Q.REG_DT, 'YY.MM.DD')
    	END AS DT,
    	 CASE WHEN TO_CHAR(Q.ANSWER_DT,'YY.MM.DD') = TO_CHAR(SYSDATE, 'YY.MM.DD')
            THEN TO_CHAR(Q.ANSWER_DT, 'HH24:MI')
            ELSE TO_CHAR(Q.ANSWER_DT, 'YY.MM.DD')
    	END AS ADT  
    	FROM QNA Q INNER JOIN MEMBER M
    	ON Q.MEM_NUM = M.MEM_NUM
    	WHERE Q.DEL = 1
    	AND Q.QNA_NUM = #{no}
</select>

<select id="qnaCnt" parameterType="hashmap" resultType="Integer"><!-- 숫자만 돌려주니깐 -->
		SELECT  COUNT(*) AS CNT
		FROM QNA Q INNER JOIN MEMBER M
    	ON Q.MEM_NUM = M.MEM_NUM
    	WHERE Q.DEL = 1
		<if test="searchTxt != null and searchTxt != ''">
    <choose>
    	<when test = "searchGbn eq title">
    		AND Q.TITLE LIKE '%' || #{searchTxt} || '%'
    	</when>
    	
    	<when test = "searchGbn eq nickname">
    		AND M.NM LIKE '%' || #{searchTxt} || '%'
    	</when>
    	
    </choose>
    
    </if>
 </select>   
    <insert id="insert" parameterType="hashmap">
	INSERT INTO QNA(QNA_NUM,MEM_NUM,TITLE,CON)
	VALUES(QNA_SEQ.NEXTVAL, #{title},#{memNo},#{con},#{att},#{cateNo})
	</insert>
	
	
	<update id="commentinsert" parameterType="hashmap">
		UPDATE QNA SET ANSWER_MEM = 0,
            ANSWER_CON=#{con},ANSWER_DT=SYSDATE
	</update>
</mapper>